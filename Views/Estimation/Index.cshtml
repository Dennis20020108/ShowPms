@{
}
<style>
    :root {
        --primary-green: #28a745;
        --light-green: #d4edda;
        --dark-green: #1e7e34;
        --muted-green: #6c757d;
    }

    .bg-primary-green {
        background-color: var(--primary-green) !important;
    }

    .text-primary-green {
        color: var(--primary-green) !important;
    }

    .btn-primary-green {
        background-color: var(--primary-green);
        border-color: var(--primary-green);
        color: white;
    }

        .btn-primary-green:hover {
            background-color: var(--dark-green);
            border-color: var(--dark-green);
            color: white;
        }

    .btn-outline-primary-green {
        background-color: transparent;
        border-color: var(--primary-green);
        color: var(--primary-green);
    }

        .btn-outline-primary-green:hover {
            background-color: var(--primary-green);
            border-color: var(--primary-green);
            color: white;
        }

    .btn-secondary-green {
        background-color: var(--muted-green);
        border-color: var(--muted-green);
        color: white;
    }

        .btn-secondary-green:hover {
            background-color: #5a6268;
            border-color: #545b62;
            color: white;
        }

    .table-hover tbody tr:hover {
        background-color: var(--light-green);
    }

    .card {
        border: 1px solid var(--primary-green);
    }

    .card-header {
        background-color: var(--light-green);
        border-bottom: 1px solid var(--primary-green);
    }

    .form-select:focus, .form-control:focus {
        border-color: var(--primary-green);
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }

    .checkbox-custom {
        transform: scale(1.2);
        accent-color: var(--primary-green);
    }

    .section-divider {
        border-top: 2px solid var(--primary-green);
        margin: 20px 0;
    }

    .editable-cell {
        background-color: #f8f9fa;
        border: 1px solid transparent;
        padding: 5px;
        border-radius: 3px;
    }

        .editable-cell:focus {
            background-color: white;
            border-color: var(--primary-green);
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

    .save-indicator {
        color: var(--primary-green);
        font-size: 0.8em;
        opacity: 0;
        transition: opacity 0.3s;
    }

        .save-indicator.show {
            opacity: 1;
        }

    /* 查詢區域樣式 */
    .query-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
        border: 2px solid var(--primary-green);
    }

    .query-hint {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 4px;
    }

    .search-stats {
        background-color: #fff3e0;
        border-left: 4px solid #ff9800;
        padding: 10px;
        margin-top: 15px;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .clear-option {
        color: #6c757d;
        font-style: italic;
    }

    .keyword-highlight {
        background-color: yellow;
        font-weight: bold;
    }

    .advanced-search-toggle {
        cursor: pointer;
        user-select: none;
        transition: all 0.3s ease;
    }

        .advanced-search-toggle:hover {
            color: var(--primary-green);
        }

    .advanced-search-panel {
        display: none;
        margin-top: 15px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

        /* 修復：添加 .show 類別樣式 */
        .advanced-search-panel.show {
            display: block !important;
        }

    /* 分類標籤樣式 */
    .category-badge {
        font-size: 0.75em;
        font-weight: 600;
        padding: 0.25em 0.6em;
        border-radius: 0.375rem;
        display: inline-block;
        margin-right: 0.25rem;
        white-space: nowrap;
    }

    .major-category-badge {
        background-color: var(--primary-green);
        color: white;
    }

    .middle-category-badge {
        background-color: var(--muted-green);
        color: white;
    }

    /* 表格列分組樣式 */
    .category-group-row {
        background-color: #f8f9fa;
        font-weight: 600;
        border-top: 2px solid var(--primary-green);
    }

        .category-group-row td {
            padding: 12px 8px;
            color: var(--dark-green);
        }
</style>

<div class="app-content-header">
    <div class="container-fluid">
        <!-- 主標題區域 -->
        <div class="row">
            <div class="col-sm-6">
                <h3 class="mb-0">
                    建立估價單
                </h3>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                    <li class="breadcrumb-item">
                        <a href="#">Home</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">建立估價單</li>
                </ol>
            </div>
        </div>
    </div>
</div>
        <!-- 舊價彈性查詢區域 -->
        <div class="query-section">
            <h5 class="text-primary-green mb-3">
                <i class="fas fa-search"></i> 舊價資料查詢
            </h5>

            <!-- 查詢提示 -->
            <div class="query-hint">
                <i class="fas fa-info-circle"></i>
                <strong>彈性查詢說明：</strong>可單獨選擇分類，或直接關鍵字搜尋。支援項目名稱、編碼、供應商、規格等欄位查詢。
            </div>

            <!-- 主要查詢區域 -->
            <div class="row">

                <!-- 主類 -->
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold text-primary-green">
                        <i class="fas fa-layer-group"></i> 主類：
                    </label>
                    <select class="form-select" id="mainCategory">
                        <option value="" class="clear-option">不限制（顯示全部）</option>
                        <option value="裝修工程">裝修工程</option>
                    </select>
                </div>

                <!-- 次類 -->
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold text-primary-green">
                        <i class="fas fa-list"></i> 次類：
                    </label>
                    <select class="form-select" id="subCategory">
                        <option value="" class="clear-option">不限制（顯示全部）</option>
                        <option value="櫥櫃工程">櫥櫃工程</option>
                    </select>
                </div>

                <!-- 品項 -->
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold text-primary-green">
                        <i class="fas fa-box-open"></i> 項目：
                    </label>
                    <select class="form-select" id="itemSelect">
                        <option value="" class="clear-option">不限制（顯示全部）</option>
                        <option value="高櫃">高櫃</option>
                        <option value="矮櫃">矮櫃</option>
                    </select>
                </div>


                <!-- 關鍵字搜尋 -->
                <div class="col-md-12 mb-3">
                    <label class="form-label fw-bold text-primary-green">
                        <i class="fas fa-search"></i> 關鍵字搜尋：
                    </label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="keywordSearch"
                               placeholder="輸入項目名稱、編碼、供應商等..."
                               onkeypress="handleKeywordEnter(event)">
                        <button class="btn btn-outline-primary-green" onclick="clearKeyword()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 查詢按鈕區域 -->
            <div class="row mt-3">
                <div class="col-12">
                    <button class="btn btn-primary-green me-2" onclick="performSearch()">
                        <i class="fas fa-search"></i> 執行查詢
                    </button>
                    <button class="btn btn-outline-primary-green me-2" onclick="resetSearch()">
                        <i class="fas fa-undo"></i> 重置條件
                    </button>
                </div>
            </div>

            <!-- 搜尋統計 -->
            <div class="search-stats" id="searchStats" style="display: none;">
                <i class="fas fa-chart-bar"></i>
                <span id="searchStatsText"></span>
            </div>
        </div>

        <!-- 舊價項目清單 -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0 text-primary-green">
                        <i class="fas fa-list"></i> 舊價項目清單
                    </h5>
                    <small class="text-muted">[☑] 表示已勾選加入估價單 | 點擊列可快速勾選</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary-green me-2" onclick="selectAllSearchResults()">
                        <i class="fas fa-check-square"></i> 全選可見
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearAllSearchSelections()">
                        <i class="fas fa-square"></i> 清除選取
                    </button>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-success">
                            <tr>
                                <th width="50">
                                    <input type="checkbox" class="form-check-input" id="selectAllEstimate" onchange="toggleSelectAllEstimate()">
                                </th>
                                <th>編號</th>
                                <th>供應商</th>
                                <th>主類</th>
                                <th>次類</th>
                                <th>項目</th>
                                <th>規格</th>
                                <th>數量</th>
                                <th>原單價</th>
                                <th>原複價</th>
                                <th>合約單價</th>
                                <th>合約複價</th>
                            </tr>
                        </thead>
                        <tbody id="oldPriceList">
                            <tr>
                                <td colspan="13" class="text-center text-muted py-4">
                                    <i class="fas fa-search fa-2x mb-2"></i>
                                    <br>
                                    請設定查詢條件後點擊「執行查詢」開始搜尋
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary-green" onclick="addToEstimate()">
                            <i class="fas fa-plus"></i> 加入估價單
                        </button>
                        <button class="btn btn-outline-primary-green" onclick="refreshList()">
                            <i class="fas fa-sync-alt"></i> 重新整理
                        </button>
                    </div>
                    <div id="selectionInfo" class="text-muted">
                        <i class="fas fa-info-circle"></i> 已選取
                        <span id="selectedCount">0</span> 個項目
                    </div>
                </div>
            </div>
        </div>

        <!-- 工程名稱 -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-primary-green">工程名稱：</label>
                        <input type="text" class="form-control" id="projectName" placeholder="請先點選右側按鈕產生工程名稱" readonly>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#projectNameModal">
                            設定工程名稱
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
<!-- 工程名稱 Modal -->
<div class="modal fade" id="projectNameModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="projectNameForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="projectNameModalLabel">設定專案名稱</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="location" class="form-label">地點</label>
                        <select class="form-select" id="location" required>
                            <option value="" selected disabled>請選擇地點</option>
                            <option value="cs">彰秀</option>
                            <option value="bs">濱秀</option>
                            <option value="gs">高秀</option>
                            <option value="ns">南市醫</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="building" class="form-label">棟別</label>
                        <select class="form-select" id="building" required>
                            <option value="" selected disabled>請選擇棟別</option>
                            <option value="A">A棟</option>
                            <option value="B">B棟</option>
                            <option value="C">C棟</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="floor" class="form-label">樓層</label>
                        <select class="form-select" id="floor" required>
                            <option value="" selected disabled>請選擇樓層</option>
                            <option value="1">1樓</option>
                            <option value="2">2樓</option>
                            <option value="3">3樓</option>
                            <option value="4">4樓</option>
                            <option value="5">5樓</option>
                            <option value="6">6樓</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">內容</label>
                        <input type="text" class="form-control" id="content" placeholder="請輸入內容" required>
                    </div>                 
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">確認</button>
                </div>
            </form>
        </div>
    </div>
</div>

        <!-- 已選項目區域 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-primary-green">
                    <i class="fas fa-edit"></i> 已選項目（可編輯）
                </h5>

                <!-- 使用 ms-auto 推到右側 -->
                <div class="d-flex gap-2 ms-auto">
                    <button class="btn btn-primary-green" onclick="addNewItem()">
                        <i class="fas fa-plus"></i> 新增項目
                    </button>
                    <button class="btn btn-secondary-green" onclick="deleteSelected()">
                        <i class="fas fa-trash"></i> 刪除選取
                    </button>
                    <button class="btn btn-outline-primary-green" onclick="saveData()">
                        <i class="fas fa-save"></i> 儲存資料
                    </button>
                    <button class="btn btn-success" onclick="exportExcel()">
                        <i class="fas fa-file-export"></i> 匯出空白估價單
                    </button>
                </div>
            </div>


            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-success">
                            <tr>
                                <th width="50">
                                    <input type="checkbox" class="form-check-input" id="selectAllEstimate" onchange="toggleSelectAllEstimate()">
                                </th>
                                <th>編號</th>
                                <th>供應商</th>
                                <th>主類</th>
                                <th>次類</th>
                                <th>項目</th>
                                <th>規格</th>
                                <th>數量</th>
                                <th>原單價</th>
                                <th>原複價</th>
                                <th>合約單價</th>
                                <th>合約複價</th>
                            </tr>
                </thead>
                        <tbody id="selectedItemsList">
                            <tr>
                                <td colspan="13" class="text-center text-muted py-4">
                                    <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                                    <br>
                                    尚未選取任何項目
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // 假資料範例
        const mockData = [
            {
                id: '001',
                supplier: '億成木業',
                mainCategory: '裝修工程',
                subCategory: '櫥櫃工程',
                item: '高櫃',
                spec: '系統櫃 E1 板材 含五金',
                quantity: 1,
                originalUnit: 1000,
                originalTotal: 1000,
                contractUnit: 950,
                contractTotal: 950
            },
            {
                id: '002',
                supplier: '昇佳木業',
                mainCategory: '裝修工程',
                subCategory: '櫥櫃工程',
                item: '矮櫃',
                spec: '系統櫃 E1 板材',
                quantity: 2,
                originalUnit: 800,
                originalTotal: 1600,
                contractUnit: 760,
                contractTotal: 1520
            },
            {
                id: '003',
                supplier: '億成木業',
                mainCategory: '裝修工程',
                subCategory: '櫥櫃工程',
                item: '高櫃',
                spec: '實木櫃體 含玻璃門片',
                quantity: 1,
                originalUnit: 2500,
                originalTotal: 2500,
                contractUnit: 2300,
                contractTotal: 2300
            },
            {
                id: '004',
                supplier: '鑫豪廚具',
                mainCategory: '裝修工程',
                subCategory: '櫥櫃工程',
                item: '矮櫃',
                spec: '廚房下櫃 含人造石檯面',
                quantity: 3,
                originalUnit: 1200,
                originalTotal: 3600,
                contractUnit: 1150,
                contractTotal: 3450
            }
        ];

        // 已選項目列表
        let selectedItems = [];

        // ========== 等待 DOM 載入完成 ==========
        document.addEventListener('DOMContentLoaded', function() {
            initProjectNameForm();
        });

        // ========== 工程名稱相關 ==========
        function initProjectNameForm() {
            const form = document.getElementById('projectNameForm');
            if (!form) return;

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                try {
                    const locationSelect = document.getElementById('location');
                    const buildingSelect = document.getElementById('building');
                    const floorSelect = document.getElementById('floor');
                    const contentInput = document.getElementById('content');
                    
                    // 驗證
                    if (!locationSelect.value || !buildingSelect.value || !floorSelect.value || !contentInput.value) {
                        alert('請填寫所有欄位！');
                        return;
                    }
                    
                    // 取得選中的選項文字
                    const location = locationSelect.options[locationSelect.selectedIndex].text;
                    const building = buildingSelect.options[buildingSelect.selectedIndex].text;
                    const floor = floorSelect.options[floorSelect.selectedIndex].text;
                    const content = contentInput.value;
                    
                    // 組合工程名稱
                    const projectName = `${location}-${building}-${floor}-${content}`;
                    document.getElementById('projectName').value = projectName;
                    
                    // 關閉 Modal (Bootstrap 5 方式)
                    const modalElement = document.getElementById('projectNameModal');
                    try {
                        let modalInstance = bootstrap.Modal.getInstance(modalElement);
                        if (!modalInstance) {
                            modalInstance = new bootstrap.Modal(modalElement);
                        }
                        modalInstance.hide();

                        //若 Bootstrap 動畫卡住，自動清理灰幕
                        setTimeout(() => {
                            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
                            modalElement.classList.remove('show');
                            modalElement.style.display = 'none';
                            document.body.classList.remove('modal-open');
                            document.body.style.overflow = '';
                        }, 600);
                    } catch (err) {
                        console.error('Modal 關閉失敗:', err);
                    }

                    // 重置表單
                    form.reset();
                    
                } catch (error) {
                    console.error('設定工程名稱發生錯誤:', error);
                    alert('設定失敗，請重試');
                }
            });
        }

        // ========== 搜尋相關 ==========
        function performSearch() {
            const mainCategory = document.getElementById('mainCategory').value;
            const subCategory = document.getElementById('subCategory').value;
            const itemSelect = document.getElementById('itemSelect').value;
            const keyword = document.getElementById('keywordSearch').value.trim().toLowerCase();

            let filteredData = mockData.filter(item => {
                if (mainCategory && item.mainCategory !== mainCategory) return false;
                if (subCategory && item.subCategory !== subCategory) return false;
                if (itemSelect && item.item !== itemSelect) return false;
                if (keyword) 
                {
                    const searchText = `${item.id} ${item.supplier} ${item.mainCategory} ${item.subCategory} ${item.item} ${item.spec}`.toLowerCase();
                    if (!searchText.includes(keyword)) return false;
                }
                return true;
            });

            renderTable(filteredData);

            const statsDiv = document.getElementById('searchStats');
            const statsText = document.getElementById('searchStatsText');
            if (statsDiv && statsText) {
                statsDiv.style.display = 'block';
                statsText.textContent = `查詢完成！共找到 ${filteredData.length} 筆符合條件的項目`;
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('oldPriceList');
            if (!tbody) return;

            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <br>
                            查無符合條件的項目
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = data.map(item => `
                <tr onclick="toggleRowSelection(this)" style="cursor: pointer;">
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input item-checkbox"
                               data-id="${item.id}"
                               onclick="event.stopPropagation(); updateSelectionCount();">
                    </td>
                    <td>${item.id}</td>
                    <td>${item.supplier}</td>
                    <td>${item.mainCategory}</td>
                    <td>${item.subCategory}</td>
                    <td>${item.item}</td>
                    <td>${item.spec}</td>
                    <td class="text-end">${item.quantity}</td>
                    <td class="text-end">$${item.originalUnit.toLocaleString()}</td>
                    <td class="text-end">$${item.originalTotal.toLocaleString()}</td>
                    <td class="text-end">$${item.contractUnit.toLocaleString()}</td>
                    <td class="text-end">$${item.contractTotal.toLocaleString()}</td>
                </tr>
            `).join('');

            updateSelectionCount();
        }

        function toggleRowSelection(row) {
            const checkbox = row.querySelector('.item-checkbox');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateSelectionCount();
            }
        }

        function updateSelectionCount() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            const countElement = document.getElementById('selectedCount');
            if (countElement) {
                countElement.textContent = checkboxes.length;
            }
        }

        function resetSearch() {
            document.getElementById('mainCategory').value = '';
            document.getElementById('subCategory').value = '';
            document.getElementById('itemSelect').value = '';
            document.getElementById('keywordSearch').value = '';

            const statsDiv = document.getElementById('searchStats');
            if (statsDiv) {
                statsDiv.style.display = 'none';
            }

            const tbody = document.getElementById('oldPriceList');
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="text-center text-muted py-4">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <br>
                            請設定查詢條件後點擊「執行查詢」開始搜尋
                        </td>
                    </tr>
                `;
            }
        }

        function clearKeyword() {
            document.getElementById('keywordSearch').value = '';
        }

        function handleKeywordEnter(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }

        function selectAllSearchResults() {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            updateSelectionCount();
        }

        function clearAllSearchSelections() {
            const checkboxes = document.querySelectorAll('.item-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            updateSelectionCount();
        }

        function refreshList() {
            performSearch();
        }

        // ========== 加入估價單 ==========
        function addToEstimate() {
            const checkboxes = document.querySelectorAll('.item-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('請先選取要加入的項目！');
                return;
            }
            
            checkboxes.forEach(checkbox => {
                const id = checkbox.getAttribute('data-id');
                const item = mockData.find(d => d.id === id);
                if (item && !selectedItems.some(si => si.id === id)) {
                    selectedItems.push({...item});
                }
            });
            
            renderSelectedItems();
            clearAllSearchSelections();
            alert(`已將 ${checkboxes.length} 個項目加入估價單！`);
        }

        // ========== 渲染已選項目 ==========
        function renderSelectedItems() {
            const tbody = document.getElementById('selectedItemsList');
            if (!tbody) return;

            if (selectedItems.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="text-center text-muted py-4">
                            <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                            <br>
                            尚未選取任何項目
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = selectedItems.map((item, index) => `
                <tr>
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input estimate-checkbox" data-index="${index}">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm" value="${item.id}"
                               onchange="updateItem(${index}, 'id', this.value)">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm" value="${item.supplier || ''}"
                               onchange="updateItem(${index}, 'supplier', this.value)">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm" value="${item.mainCategory}"
                               onchange="updateItem(${index}, 'mainCategory', this.value)">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm" value="${item.subCategory}"
                               onchange="updateItem(${index}, 'subCategory', this.value)">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm" value="${item.item}"
                               onchange="updateItem(${index}, 'item', this.value)">
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm" value="${item.spec}"
                               onchange="updateItem(${index}, 'spec', this.value)">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm text-end" value="${item.quantity}"
                               onchange="updateItem(${index}, 'quantity', parseFloat(this.value))">
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm text-end" value="${item.originalUnit}"
                               onchange="updateItem(${index}, 'originalUnit', parseFloat(this.value))">
                    </td>
                    <td class="text-end">$${item.originalTotal.toLocaleString()}</td>
                    <td>
                        <input type="number" class="form-control form-control-sm text-end" value="${item.contractUnit}"
                               onchange="updateItem(${index}, 'contractUnit', parseFloat(this.value))">
                    </td>
                    <td class="text-end">$${item.contractTotal.toLocaleString()}</td>
                </tr>
            `).join('');
        }

        // ========== 更新項目資料 ==========
        function updateItem(index, field, value) {
            selectedItems[index][field] = value;
            
            // 自動計算複價
            if (field === 'quantity' || field === 'originalUnit') {
                selectedItems[index].originalTotal = selectedItems[index].quantity * selectedItems[index].originalUnit;
            }
            if (field === 'quantity' || field === 'contractUnit') {
                selectedItems[index].contractTotal = selectedItems[index].quantity * selectedItems[index].contractUnit;
            }
            
            renderSelectedItems();
        }

        // ========== 新增項目 ==========
        function addNewItem() {
            const newItem = {
                id: '',
                supplier: '',
                mainCategory: '',
                subCategory: '',
                item: '',
                spec: '',
                quantity: 0,
                originalUnit: 0,
                originalTotal: 0,
                contractUnit: 0,
                contractTotal: 0
            };

            selectedItems.push(newItem);
            renderSelectedItems();
        }

        // ========== 刪除選取項目 ==========
        function deleteSelected() {
            const checkboxes = document.querySelectorAll('.estimate-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('請先選取要刪除的項目！');
                return;
            }
            
            if (!confirm(`確定要刪除選取的 ${checkboxes.length} 個項目嗎？`)) {
                return;
            }
            
            const indicesToDelete = Array.from(checkboxes).map(cb => parseInt(cb.getAttribute('data-index')));
            selectedItems = selectedItems.filter((item, index) => !indicesToDelete.includes(index));
            
            renderSelectedItems();
            alert('已刪除選取的項目！');
        }

        // ========== 全選/取消全選 ==========
        function toggleSelectAllEstimate() {
            const selectAll = document.getElementById('selectAllEstimate');
            const checkboxes = document.querySelectorAll('.estimate-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        // ========== 儲存資料 ==========
        function saveData() {
            const projectName = document.getElementById('projectName').value;
            
            if (!projectName) {
                alert('請先設定工程名稱！');
                return;
            }
            
            if (selectedItems.length === 0) {
                alert('尚無項目可儲存！');
                return;
            }
            
            const data = {
                projectName: projectName,
                items: selectedItems,
                saveTime: new Date().toLocaleString('zh-TW')
            };
            
            console.log('儲存資料：', data);
            alert('資料已儲存！');
        }

        // ========== 匯出 Excel ==========
        function exportExcel() {
            const projectName = document.getElementById('projectName').value;
            
            if (!projectName) {
                alert('請先設定工程名稱！');
                return;
            }
            
            if (selectedItems.length === 0) {
                alert('尚無項目可匯出！');
                return;
            }
            
            alert(`準備匯出：${projectName}\n共 ${selectedItems.length} 個項目`);
        }
    </script>
}