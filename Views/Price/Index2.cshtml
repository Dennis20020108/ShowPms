@{ Layout = null;}

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>舊價資料庫選取畫面</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-green: #28a745;
            --light-green: #d4edda;
            --dark-green: #1e7e34;
            --muted-green: #6c757d;
        }

        .bg-primary-green {
            background-color: var(--primary-green) !important;
        }

        .text-primary-green {
            color: var(--primary-green) !important;
        }

        .btn-primary-green {
            background-color: var(--primary-green);
            border-color: var(--primary-green);
            color: white;
        }

            .btn-primary-green:hover {
                background-color: var(--dark-green);
                border-color: var(--dark-green);
                color: white;
            }

        .btn-outline-primary-green {
            background-color: transparent;
            border-color: var(--primary-green);
            color: var(--primary-green);
        }

            .btn-outline-primary-green:hover {
                background-color: var(--primary-green);
                border-color: var(--primary-green);
                color: white;
            }

        .btn-secondary-green {
            background-color: var(--muted-green);
            border-color: var(--muted-green);
            color: white;
        }

            .btn-secondary-green:hover {
                background-color: #5a6268;
                border-color: #545b62;
                color: white;
            }

        .table-hover tbody tr:hover {
            background-color: var(--light-green);
        }

        .card {
            border: 1px solid var(--primary-green);
        }

        .card-header {
            background-color: var(--light-green);
            border-bottom: 1px solid var(--primary-green);
        }

        .form-select:focus, .form-control:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        .checkbox-custom {
            transform: scale(1.2);
            accent-color: var(--primary-green);
        }

        .section-divider {
            border-top: 2px solid var(--primary-green);
            margin: 20px 0;
        }

        .editable-cell {
            background-color: #f8f9fa;
            border: 1px solid transparent;
            padding: 5px;
            border-radius: 3px;
        }

            .editable-cell:focus {
                background-color: white;
                border-color: var(--primary-green);
                outline: none;
                box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
            }

        .save-indicator {
            color: var(--primary-green);
            font-size: 0.8em;
            opacity: 0;
            transition: opacity 0.3s;
        }

            .save-indicator.show {
                opacity: 1;
            }
    </style>
</head>
<body>
    <div class="container-fluid py-3">
        <!-- 主標題區域 -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0 text-primary-green">
                    <i class="fas fa-building"></i> 舊價資料庫選取畫面
                </h4>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary-green" onclick="exportEstimate()">
                        <i class="fas fa-file-alt"></i> 匯出估價單
                    </button>
                    <button class="btn btn-outline-primary-green" onclick="exportBlankEstimate()">
                        <i class="fas fa-file"></i> 空白估價單
                    </button>
                </div>
            </div>
        </div>

        <!-- 選擇區域 -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-primary-green">
                            <i class="fas fa-chevron-down"></i> 大項目:
                        </label>
                        <select class="form-select" id="majorCategory">
                            <option value="裝修">裝修</option>
                            <option value="水電">水電</option>
                            <option value="空調">空調</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-primary-green">
                            <i class="fas fa-chevron-down"></i> 中項目:
                        </label>
                        <select class="form-select" id="middleCategory">
                            <option value="室內隔間工程">室內隔間工程</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-primary-green">
                            <i class="fas fa-chevron-down"></i> 分類:
                        </label>
                        <select class="form-select" id="subCategory">
                            <option value="">請選擇分類</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-primary-green">
                            <i class="fas fa-search"></i> 篩選:
                        </label>
                        <button class="btn btn-primary-green w-100" onclick="searchItems()">
                            <i class="fas fa-search"></i> 查詢小項目
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 舊價小項目清單 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0 text-primary-green">
                    <i class="fas fa-check-circle"></i> 舊價小項目清單（依條件查詢後顯示，可勾選加入估價單）
                </h5>
                <small class="text-muted">[☑] 表示已勾選加入估價單</small>
            </div>

            <!-- 搜尋輸入欄 -->
            <div class="px-3 py-2 border-bottom bg-white">
                <div class="input-group">
                    <input type="text" class="form-control" id="searchInput" placeholder="輸入關鍵字搜尋小項目..." oninput="filterItems()">
                    <button class="btn btn-outline-primary-green" onclick="clearSearch()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-success">
                            <tr>
                                <th width="50">選取</th>
                                <th>編碼</th>
                                <th>小項目名稱</th>
                                <th>單位</th>
                                <th>數量</th>
                                <th>原單價</th>
                                <th>原複價</th>
                                <th>合約單價</th>
                                <th>合約複價</th>
                                <th>備註</th>
                            </tr>
                        </thead>
                        <tbody id="oldPriceList">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex gap-2">
                    <button class="btn btn-primary-green" onclick="addToEstimate()">
                        <i class="fas fa-check"></i> 加入估價單
                    </button>
                    <button class="btn btn-outline-primary-green" onclick="refreshList()">
                        <i class="fas fa-sync-alt"></i> 重新整理
                    </button>
                </div>
            </div>
        </div>

        <!-- 分隔線 -->
        <div class="section-divider"></div>

        <!-- 已選項目區域 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-primary-green">
                    <i class="fas fa-edit"></i> 已選項目（可編輯）
                </h5>
                <div class="save-indicator" id="saveIndicator">
                    <i class="fas fa-check-circle"></i> 已自動儲存
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-success">
                            <tr>
                                <th width="50">
                                    <input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll()">
                                </th>
                                <th>編號</th>
                                <th>編碼</th>
                                <th>小項目名稱</th>
                                <th>規格/說明</th>
                                <th>單位</th>
                                <th>數量</th>
                                <th>原單價</th>
                                <th>原複價</th>
                                <th>合約單價</th>
                                <th>合約複價</th>
                                <th>備註</th>
                            </tr>
                        </thead>
                        <tbody id="selectedItemsList">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="d-flex gap-2">
                    <button class="btn btn-primary-green" onclick="addNewItem()">
                        <i class="fas fa-plus"></i> 新增項目
                    </button>
                    <button class="btn btn-secondary-green" onclick="deleteSelected()">
                        <i class="fas fa-trash"></i> 刪除選取
                    </button>
                    <button class="btn btn-outline-primary-green" onclick="saveData()">
                        <i class="fas fa-save"></i> 儲存資料
                    </button>
                    <button class="btn btn-primary-green" onclick="exportToExcel()">
                        <i class="fas fa-download"></i> 匯出Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新增項目模態框 -->
    <div class="modal fade" id="addItemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title text-primary-green">新增項目</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">編碼</label>
                            <input type="text" class="form-control" id="newItemCode" placeholder="請輸入編碼">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">單位</label>
                            <input type="text" class="form-control" id="newItemUnit" placeholder="請輸入單位">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label class="form-label">小項目名稱</label>
                            <input type="text" class="form-control" id="newItemName" placeholder="請輸入項目名稱">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label class="form-label">規格/說明</label>
                            <textarea class="form-control" id="newItemSpec" rows="3" placeholder="請輸入規格說明"></textarea>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <label class="form-label">數量</label>
                            <input type="number" class="form-control" id="newItemQuantity" placeholder="0" onchange="calculateNewItemTotal()">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">原單價</label>
                            <input type="number" class="form-control" id="newItemUnitPrice" placeholder="0" onchange="calculateNewItemTotal()">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">原複價</label>
                            <input type="number" class="form-control" id="newItemTotalPrice" placeholder="0" readonly>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <label class="form-label">備註</label>
                            <input type="text" class="form-control" id="newItemNote" placeholder="請輸入備註">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary-green" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary-green" onclick="confirmAddItem()">確認新增</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // 大項目和中項目的對應關係
        const categoryMapping = {
            '裝修': ['假設工程', '室內隔間工程', '天花板裝修工程', '牆面裝修工程', '地坪裝修工程',
                '地坪P.V.C無縫地毯工程', '地坪磁磚(材料)', '樓梯間裝修工程',
                '內部門工程', '特殊裝修工程', '系統廚櫃工程', '雜項工程'],
            '水電': ['給水工程', '排水工程', '電氣工程'],
            '空調': ['空調設備', '通風工程', '冷卻水塔']
        };

        // 中項目和細項分類的對應關係
        const subCategoryMapping = {
            '假設工程': ['臨時設施', '工務管理', '清潔維護'],
            '室內隔間工程': ['基礎工程', '輕隔間牆體-Type A', '輕隔間牆體-Type B', '輕隔間牆體-Type C', '輕隔間牆體-Type N', '輕隔間牆體-Type O', '其他隔間工程'],
            '內部門工程': ['木質防火門', '木質門','鏽鋼電動橫拉防火門'],
            '天花板裝修工程': ['輕鋼架系統', '板材系統', '特殊造型'],
            '牆面裝修工程': ['油漆工程', '貼磚工程', '特殊材料'],
            '地坪裝修工程': ['基礎處理', '磁磚工程', '木地板工程'],
            '給水工程': ['管路配置', '設備安裝', '測試驗收'],
            '排水工程': ['污水系統', '雨水系統', '通氣系統'],
            '電氣工程': ['配電系統', '照明系統', '弱電系統']
        };

        // 細項分類對應的小項目資料
        const itemsData = {
            '基礎工程': [
                { code: 'A02-001', name: '放樣工程', unit: 'm²', quantity: '32555', unitPrice: '47', totalPrice: '1530085', note: '總樓地板面積' }
            ],
            '輕隔間牆體-Type A': [
                { code: 'A02-015-T', name: 'Type-A 9mm單層雙面矽酸鈣板輕隔間牆至頂(C型立柱92x35x0.95mm骨架@406mm,60K/50mm岩棉)', unit: 'm²', quantity: '3468', unitPrice: '1292', totalPrice: '4480656', note: 'A13-21' },
            ],
            '輕隔間牆體-Type B': [
                { code: 'A02-016-T', name: 'Type-B 9,12mm單層雙面矽酸鈣板輕隔間牆,面刷一底二度水泥漆(外立面)(CH型立柱92x35x0.95mm骨架@610mm,60K/50mm岩棉)', unit: 'm²', quantity: '35', unitPrice: '1870', totalPrice: '65450', note: 'A13-21虹牌、得利同外牆玻璃色漆' },
            ],
            '輕隔間牆體-Type C': [
                {
                    code: 'A02-017-T', name: '9mm單層雙面矽酸鈣板輕隔間牆至頂(C型立柱125x35x0.95mm骨架@305mm,60K/50mm岩棉)', unit: 'm²', quantity: '13404', unitPrice: '1437', totalPrice: '19261548', note: 'A13-21'
                },
            ],
            '輕隔間牆體-Type N': [
                {
                    code: 'A02-030-T', name: '9,12mm單層雙面矽酸鈣板管道輕隔間牆至頂(CH型立柱92x35x0.95mm骨架@610mm,60K/50mm岩棉及15cm高2500PSI R.C止水墩，植筋#3@20cm模板)', unit: 'm²', quantity: '652', unitPrice: '1456', totalPrice: '949312', note: 'A13-22'
                },
                {
                    code: 'A02-030-T1', name: '9mm單層單面矽酸鈣板+12mm單層單面纖維水泥板管道輕隔間牆至頂(CH型立柱92x35x0.95mm ', unit: 'm²', quantity: '119', unitPrice: '1468', totalPrice: '174692', note: 'A13-222F - 71、4F-05、5F-05、6F-05、7F-05、8F-03、R1F- 04'
                },
            ],
            '輕隔間牆體-Type O': [
                {
                    code: 'A02-033-T', name: '9,12mm單層雙面矽酸鈣板管道輕隔間牆至頂(CH型立柱125x35x0.95mm骨架@305mm,60K/50mm岩棉及15cm高2500PSI R.C止水墩，植筋#3@20cm.模板)', unit: 'm²', quantity: '307', unitPrice: '1761', totalPrice: '540627', note: 'A13-22'
                },
                {
                    code: 'A02-033-T1', name: '9mm單層單面矽酸鈣板+12mm單層單面纖維水泥板管道輕隔間牆至頂(CH型立柱125x35x0.95mm 骨架@610mm,60K/50mm岩棉及15cm高2500PSI R.C止水墩，植筋#3@20cm.模板)', unit: 'm²', quantity: '43', unitPrice: '1523', totalPrice: '65489', note: 'A13-221F - 54、3F - 87'
                },
            ],
            '臨時設施': [
                { code: 'A01-001', name: '臨時水、電、電信費', unit: '式', quantity: '1', unitPrice: '378000', totalPrice: '378000', note: '' },
                { code: 'A01-002', name: '工務所及相關設備', unit: '式', quantity: '1', unitPrice: '252000', totalPrice: '252000', note: '' }
            ],
            '工務管理': [
                { code: 'A01-010', name: '工程廢棄物處理及民生垃圾處理費', unit: '式', quantity: '1', unitPrice: '4135740', totalPrice: '4135740', note: '' }
            ],
            '清潔維護': [
                { code: 'A01-003', name: '臨時廁所、設備與維護清潔費', unit: '式', quantity: '1', unitPrice: '126000', totalPrice: '126000', note: '' }
            ],
            '輕鋼架系統': [
                { code: 'B01-001', name: '輕鋼架天花板', unit: 'm²', quantity: '1200', unitPrice: '850', totalPrice: '1020000', note: '含燈具配置' }
            ],
            '板材系統': [
                { code: 'B01-002', name: '矽酸鈣板天花板', unit: 'm²', quantity: '800', unitPrice: '950', totalPrice: '760000', note: '防火等級' }
            ],
            '管路配置': [
                { code: 'C01-001', name: '給水管配置', unit: 'm', quantity: '500', unitPrice: '320', totalPrice: '160000', note: 'PVC管材' }
            ],
            '設備安裝': [
                { code: 'C01-002', name: '給水設備安裝', unit: '組', quantity: '25', unitPrice: '8500', totalPrice: '212500', note: '含閥件' }
            ]
        };

        let itemCounter = 0;
        let selectedItems = [];

        // 當大項目改變時更新中項目選項
        document.getElementById('majorCategory').addEventListener('change', function () {
            const selectedMajor = this.value;
            const middleSelect = document.getElementById('middleCategory');
            const subSelect = document.getElementById('subCategory');

            middleSelect.innerHTML = '';
            subSelect.innerHTML = '<option value="">請選擇細項分類</option>';

            if (categoryMapping[selectedMajor]) {
                categoryMapping[selectedMajor].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    middleSelect.appendChild(option);
                });

                middleSelect.dispatchEvent(new Event('change'));
            }
        });

        // 當中項目改變時更新細項分類選項
        document.getElementById('middleCategory').addEventListener('change', function () {
            const selectedMiddle = this.value;
            const subSelect = document.getElementById('subCategory');

            subSelect.innerHTML = '<option value="">請選擇分類</option>';

            if (subCategoryMapping[selectedMiddle]) {
                subCategoryMapping[selectedMiddle].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    subSelect.appendChild(option);
                });
            }

            // 清空小項目清單
            clearItemsList();
        });

        // 當細項分類改變時可以選擇性更新小項目清單
        document.getElementById('subCategory').addEventListener('change', function () {
            const selectedSub = this.value;
            if (selectedSub) {
                updateItemsList(selectedSub);
            } else {
                clearItemsList();
            }
        });

        // 清空小項目清單
        function clearItemsList() {
            const tbody = document.getElementById('oldPriceList');
            tbody.innerHTML = '';
        }

        // 更新小項目清單
        function updateItemsList(category) {
            const tbody = document.getElementById('oldPriceList');
            tbody.innerHTML = '';

            if (itemsData[category]) {
                itemsData[category].forEach((item, index) => {
                    const row = createItemRow(item, index);
                    tbody.appendChild(row);
                });
            }
        }

        function createItemRow(item, index) {
            const row = document.createElement('tr');
            row.innerHTML = `
                            <td class="text-center">
                                <input type="checkbox" class="form-check-input checkbox-custom" id="item${index + 1}">
                            </td>
                            <td>${item.code}</td>
                            <td>${item.name}</td>
                            <td>${item.unit}</td>
                            <td>${formatNumber(item.quantity)}</td>
                            <td>${formatNumber(item.unitPrice)}</td>
                            <td>${formatNumber(item.totalPrice)}</td>
                            <td>-</td>
                            <td>-</td>
                            <td>${item.note}</td>
                        `;

            const checkbox = row.querySelector('input[type="checkbox"]');

            checkbox.addEventListener('change', function () {
                if (this.checked) {
                    addItemToSelectedList(item);
                } else {
                    removeItemFromSelectedList(item.code);
                }
            });

            row.addEventListener('click', function (e) {
                if (e.target.tagName !== 'INPUT') {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });

            return row;
        }

        function addItemToSelectedList(item) {
            const alreadyExists = selectedItems.some(selectedItem => selectedItem.code === item.code);
            if (alreadyExists) return;

            itemCounter += 1;

            const selectedItem = {
                id: itemCounter,
                code: item.code,
                name: item.name,
                spec: '',
                unit: item.unit,
                quantity: item.quantity,
                unitPrice: item.unitPrice,
                totalPrice: item.totalPrice,
                contractUnitPrice: '',
                contractTotalPrice: '',
                note: item.note
            };

            selectedItems.push(selectedItem);
            renderSelectedItems();
            autoSave();
        }

        function removeItemFromSelectedList(code) {
            selectedItems = selectedItems.filter(item => item.code !== code);
            renderSelectedItems();
            autoSave();
        }

        function renderSelectedItems() {
            const tbody = document.getElementById('selectedItemsList');
            tbody.innerHTML = '';

            selectedItems.forEach((item, index) => {
                const row = createSelectedItemRow(item, index);
                tbody.appendChild(row);
            });
        }

        function createSelectedItemRow(item, index) {
            const row = document.createElement('tr');
            row.innerHTML = `
                            <td class="text-center">
                                <input type="checkbox" class="form-check-input row-checkbox" data-id="${item.id}">
                            </td>
                            <td>${String(index + 1).padStart(3, '0')}</td>
                            <td>${item.code}</td>
                            <td class="editable-cell" contenteditable data-field="name" data-id="${item.id}">${item.name}</td>
                            <td class="editable-cell" contenteditable data-field="spec" data-id="${item.id}">${item.spec}</td>
                            <td>${item.unit}</td>
                            <td class="editable-cell" contenteditable data-field="quantity" data-id="${item.id}">${item.quantity}</td>
                            <td class="editable-cell" contenteditable data-field="unitPrice" data-id="${item.id}">${formatNumber(item.unitPrice)}</td>
                            <td class="calculated-field">${formatNumber(calculateTotal(item.quantity, item.unitPrice))}</td>
                            <td class="editable-cell" contenteditable data-field="contractUnitPrice" data-id="${item.id}">${item.contractUnitPrice}</td>
                            <td class="calculated-field">${item.contractUnitPrice ? formatNumber(calculateTotal(item.quantity, item.contractUnitPrice)) : '-'}</td>
                            <td class="editable-cell" contenteditable data-field="note" data-id="${item.id}">${item.note}</td>
                        `;

            // 添加編輯事件監聽
            const editableCells = row.querySelectorAll('.editable-cell');
            editableCells.forEach(cell => {
                cell.addEventListener('blur', function () {
                    updateItemData(this.dataset.id, this.dataset.field, this.textContent);
                });

                cell.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    }
                });
            });

            return row;
        }

        function updateItemData(id, field, value) {
            const item = selectedItems.find(item => item.id == id);
            if (item) {
                item[field] = value;

                // 如果是數量或單價變更，重新計算總價
                if (field === 'quantity' || field === 'unitPrice' || field === 'contractUnitPrice') {
                    renderSelectedItems();
                }

                autoSave();
            }
        }

        function calculateTotal(quantity, unitPrice) {
            const qty = parseFloat(quantity) || 0;
            const price = parseFloat(unitPrice) || 0;
            return qty * price;
        }

        function formatNumber(num) {
            if (!num || num === '' || num === '-') return '-';
            return parseFloat(num).toLocaleString();
        }

        // 自動儲存功能
        function autoSave() {
            const data = {
                selectedItems: selectedItems,
                timestamp: new Date().toISOString()
            };

            // 模擬儲存到本地儲存
            console.log('自動儲存資料:', data);

            // 顯示儲存指示器
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // 功能按鈕事件處理
        function searchItems() {
            const subCategory = document.getElementById('subCategory').value;
            if (!subCategory) {
                showMessage('請先選擇細項分類', 'warning');
                return;
            }
            updateItemsList(subCategory);
            showMessage('查詢完成', 'success');
        }

        function addToEstimate() {
            const checkedItems = document.querySelectorAll('#oldPriceList input[type="checkbox"]:checked');
            if (checkedItems.length === 0) {
                showMessage('請先選取要加入的項目', 'warning');
                return;
            }
            showMessage(`已選取 ${checkedItems.length} 個項目加入估價單`, 'success');
        }

        function refreshList() {
            const subCategory = document.getElementById('subCategory').value;
            if (subCategory) {
                updateItemsList(subCategory);
            } else {
                clearItemsList();
            }
            showMessage('清單已重新整理', 'info');
        }

        function addNewItem() {
            // 清空表單
            document.getElementById('newItemCode').value = '';
            document.getElementById('newItemName').value = '';
            document.getElementById('newItemSpec').value = '';
            document.getElementById('newItemUnit').value = '';
            document.getElementById('newItemQuantity').value = '';
            document.getElementById('newItemUnitPrice').value = '';
            document.getElementById('newItemTotalPrice').value = '';
            document.getElementById('newItemNote').value = '';

            // 顯示模態框
            const modal = new bootstrap.Modal(document.getElementById('addItemModal'));
            modal.show();
        }

        function calculateNewItemTotal() {
            const quantity = parseFloat(document.getElementById('newItemQuantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('newItemUnitPrice').value) || 0;
            const total = quantity * unitPrice;
            document.getElementById('newItemTotalPrice').value = total;
        }

        function confirmAddItem() {
            const code = document.getElementById('newItemCode').value.trim();
            const name = document.getElementById('newItemName').value.trim();
            const spec = document.getElementById('newItemSpec').value.trim();
            const unit = document.getElementById('newItemUnit').value.trim();
            const quantity = document.getElementById('newItemQuantity').value || '0';
            const unitPrice = document.getElementById('newItemUnitPrice').value || '0';
            const note = document.getElementById('newItemNote').value.trim();

            if (!code || !name || !unit) {
                showMessage('請填寫必要欄位：編碼、項目名稱、單位', 'warning');
                return;
            }

            // 檢查編碼是否重複
            const exists = selectedItems.some(item => item.code === code);
            if (exists) {
                showMessage('編碼已存在，請使用其他編碼', 'warning');
                return;
            }

            itemCounter += 1;

            const newItem = {
                id: itemCounter,
                code: code,
                name: name,
                spec: spec,
                unit: unit,
                quantity: quantity,
                unitPrice: unitPrice,
                totalPrice: calculateTotal(quantity, unitPrice),
                contractUnitPrice: '',
                contractTotalPrice: '',
                note: note
            };

            selectedItems.push(newItem);
            renderSelectedItems();
            autoSave();

            // 關閉模態框
            const modal = bootstrap.Modal.getInstance(document.getElementById('addItemModal'));
            modal.hide();

            showMessage('新增項目成功', 'success');
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.row-checkbox');

            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        function deleteSelected() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');

            if (checkedBoxes.length === 0) {
                showMessage('請先選取要刪除的項目', 'warning');
                return;
            }

            if (!confirm(`確定要刪除選取的 ${checkedBoxes.length} 個項目嗎？`)) {
                return;
            }

            const idsToDelete = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.id));
            selectedItems = selectedItems.filter(item => !idsToDelete.includes(item.id));

            renderSelectedItems();
            autoSave();

            document.getElementById('selectAll').checked = false;
            showMessage(`已刪除 ${checkedBoxes.length} 個項目`, 'success');
        }

        function saveData() {
            const data = {
                selectedItems: selectedItems,
                timestamp: new Date().toISOString(),
                itemCount: selectedItems.length
            };

            // 這裡可以發送到後端API
            console.log('手動儲存資料:', data);

            showMessage('資料儲存成功', 'success');
        }

        function exportEstimate() {
            if (selectedItems.length === 0) {
                showMessage('沒有選取的項目可以匯出', 'warning');
                return;
            }
            showMessage('估價單匯出功能準備中...', 'info');
        }

        function exportBlankEstimate() {
            showMessage('空白估價單匯出功能準備中...', 'info');
        }

        function exportToExcel() {
            if (selectedItems.length === 0) {
                showMessage('沒有資料可以匯出', 'warning');
                return;
            }
            showMessage('Excel匯出功能準備中...', 'info');
        }

        // 顯示訊息的輔助函數
        function showMessage(message, type = 'info') {
            const alertClass = {
                'success': 'alert-success',
                'warning': 'alert-warning',
                'error': 'alert-danger',
                'info': 'alert-info'
            };

            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${alertClass[type]} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                            ${message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;

            document.body.appendChild(alertDiv);

            // 3秒後自動移除
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // 搜尋和篩選功能
        function filterItems() {
            const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
            const rows = document.querySelectorAll('#oldPriceList tr');

            rows.forEach(row => {
                const cells = Array.from(row.children).map(cell => cell.textContent.toLowerCase());
                const matched = cells.some(cellText => cellText.includes(keyword));
                row.style.display = matched ? '' : 'none';
            });
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            filterItems();
        }

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 初始化第一層選項
            document.getElementById('majorCategory').dispatchEvent(new Event('change'));
        });
    </script>
</body>
</html>